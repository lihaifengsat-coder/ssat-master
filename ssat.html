<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSAT è¯æ±‡å¤§å¸ˆ (v4.3 è¯æ±‡åº“ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        /* ** CSS æ ·å¼éƒ¨åˆ† - ä¿æŒä¸åŸæ–‡ä»¶ä¸€è‡´ä»¥ç¡®ä¿è§†è§‰æ•ˆæœ **
        */
        :root {
            --primary: #4a90e2;
            --secondary: #f5f7fa;
            --text: #333;
            --correct: #2ecc71;
            --wrong: #e74c3c;
            --accent: #6c5ce7;
            --warning: #f1c40f;
            --ai-color: #e056fd;
            --save-color: #27ae60;
            --exam-color: #ff9f43;
            --bank-color: #1abc9c; /* New color for Word Bank */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--text);
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 800;
            color: var(--primary);
        }

        .header-controls {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: #f8f9fa;
            border: 1px solid #eee;
            font-size: 13px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
            font-weight: 600;
            color: #555;
        }
        .icon-btn:hover { background: #eee; }
        
        .ai-btn-header { color: var(--ai-color); border: 1px solid var(--ai-color); background: #fdf5ff; }
        .ai-btn-header:hover { background: #f3e5f5; }

        .save-btn-header { color: var(--save-color); border: 1px solid var(--save-color); background: #f0fff4; }
        .save-btn-header:hover { background: #dbfce6; }
        
        .sound-btn.active { background: #e3f2fd; color: var(--primary); border-color: var(--primary); }

        /* ä¸»å®¹å™¨ */
        #app-container {
            flex: 1;
            padding: 20px;
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
            overflow-y: auto;
            padding-bottom: 60px;
        }

        /* æ¨¡å¼åˆ‡æ¢å¼€å…³ */
        .mode-switch-container {
            display: flex;
            background: white;
            padding: 5px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .mode-switch-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            color: #666;
            transition: all 0.2s;
        }
        .mode-switch-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .mode-switch-btn.exam-mode.active {
            background: var(--exam-color);
        }

        /* èœå•ç•Œé¢ */
        .filter-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            background: #fff;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .menu-full-width { grid-column: 1 / -1; }

        .mode-card {
            background: white;
            padding: 25px 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .mode-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .mode-card.synonym { border-bottom: 5px solid var(--primary); }
        .mode-card.analogy { border-bottom: 5px solid var(--accent); }
        .mode-card.mistakes { border-bottom: 5px solid var(--wrong); background: #fff5f5; }
        .mode-card.wordbank { border-bottom: 5px solid var(--bank-color); } /* New style for Word Bank */

        .mode-icon { font-size: 36px; margin-bottom: 10px; display: block; }
        .mode-title { font-size: 18px; font-weight: bold; display: block; margin-bottom: 5px; }
        .mode-desc { font-size: 12px; color: #888; }
        
        .badge { background: var(--wrong); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 5px; }

        /* ç­”é¢˜ç•Œé¢ */
        .quiz-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            display: none;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .progress-bar { height: 6px; background: #eee; border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .exam-mode .progress-fill { background: var(--exam-color); }

        .set-badge { display: inline-block; background: #eee; color: #666; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; }

        .question-area { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .question-text { font-size: 28px; font-weight: bold; color: #2c3e50; font-family: "Times New Roman", serif; margin: 0; }
        .speak-btn { background: none; border: none; cursor: pointer; font-size: 24px; color: var(--primary); padding: 5px; border-radius: 50%; transition: background 0.2s; }
        .speak-btn:hover { background: #e3f2fd; }
        
        .question-type-tag { text-align: center; font-size: 12px; color: #999; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        .options-grid { display: grid; gap: 12px; }

        .option-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: "Times New Roman", serif;
        }
        .option-btn:hover { border-color: var(--primary); background: #f8fbff; }
        
        .practice-mode .option-btn.correct { background: #d4edda; border-color: var(--correct); color: #155724; }
        .practice-mode .option-btn.wrong { background: #f8d7da; border-color: var(--wrong); color: #721c24; }
        .exam-mode .option-btn.selected { background: #fff3e0; border-color: var(--exam-color); color: #e67e22; font-weight: bold; }

        .feedback-area { margin-top: 20px; text-align: center; min-height: 60px; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .action-btn { padding: 12px 25px; border-radius: 25px; font-size: 16px; cursor: pointer; border: none; }
        .next-btn { background: var(--primary); color: white; display: none; }
        .ai-explain-btn { background: white; color: var(--ai-color); border: 2px solid var(--ai-color); display: none; align-items: center; gap: 5px; }

        /* ç»“ç®—é¡µ */
        .review-list { margin-top: 20px; text-align: left; display: flex; flex-direction: column; gap: 10px; }
        .review-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #ccc;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.1s;
        }
        .review-item:hover { transform: scale(1.01); }
        .review-item.correct { border-left-color: var(--correct); }
        .review-item.wrong { border-left-color: var(--wrong); background: #fff5f5; }
        .review-q { font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; }
        .review-meta { font-size: 12px; color: #666; margin-top: 5px; }
        .ai-tag { font-size: 10px; background: var(--ai-color); color: white; padding: 2px 4px; border-radius: 3px; margin-left: 5px; display: none; }
        .review-item:hover .ai-tag { display: inline-block; }

        /* æ¨¡æ€æ¡†/é€šç”¨ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; max-height: 80vh; border-radius: 15px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; }
        .modal-body { flex: 1; padding: 20px; overflow-y: auto; font-size: 15px; line-height: 1.6; }

        textarea { width: 100%; height: 150px; font-family: monospace; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: none; box-sizing: border-box; margin-bottom: 10px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; margin-bottom: 10px; }
        
        .file-drop-area { border: 2px dashed #ccc; border-radius: 10px; padding: 20px; text-align: center; margin-bottom: 15px; background: #fdfdfd; cursor: pointer; transition: border-color 0.2s; }
        .file-drop-area:hover { border-color: var(--primary); }

        .help-text { font-size: 12px; color: #666; margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 5px; }
        .btn { padding: 8px 16px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ai { background: var(--ai-color); color: white; }
        .btn-save { background: var(--save-color); color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #333; }
        .btn-close { background: #eee; color: #333; }
        .btn-block { width: 100%; margin-bottom: 10px; }

        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--ai-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .markdown-content h3 { color: var(--ai-color); margin-top: 0; }
        .back-nav { margin-bottom: 10px; display: none; cursor: pointer; color: #666; font-size: 14px; }
        .app-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; padding: 5px 20px; font-size: 12px; color: #999; display: flex; justify-content: space-between; box-sizing: border-box; z-index: 5; }
        
        .data-action-card { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #eee; }
        .data-action-title { font-weight: bold; margin-bottom: 5px; }
        .data-action-desc { font-size: 12px; color: #666; margin-bottom: 10px; }
        
        /* Word Bank Styles */
        .word-bank-header {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .word-bank-list {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .word-item {
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        .word-item:last-child { border-bottom: none; }
        .word-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--bank-color);
            margin-bottom: 5px;
        }
        .word-detail {
            font-size: 14px;
            line-height: 1.5;
            margin-left: 15px;
        }
        .word-set-header {
            background: #f0fff4;
            color: var(--save-color);
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
            border-left: 3px solid var(--save-color);
        }
    </style>
</head>
<body>

<header>
    <h1>SSAT Prep Master</h1>
    <div class="header-controls">
        <button id="sound-toggle" class="icon-btn sound-btn" onclick="toggleSound()" title="è‡ªåŠ¨å‘éŸ³å¼€å…³">
            ğŸ”Š Auto
        </button>
        <button class="icon-btn" onclick="showImportModal()" title="æ‰¹é‡ä¸Šä¼ æ–‡æ¡£">
            ğŸ“¥ å¯¼å…¥
        </button>
        <button class="icon-btn ai-btn-header" onclick="showGenModal()" title="AI ç”Ÿæˆ">
            âœ¨ AI
        </button>
        <button class="icon-btn save-btn-header" onclick="showDataModal()" title="å¤‡ä»½/æ¢å¤æ•°æ®">
            ğŸ’¾ æ•°æ®
        </button>
    </div>
</header>

<div id="app-container">
    
    <div class="back-nav" id="back-btn" onclick="goHome()">â† è¿”å›ä¸»èœå•</div>

    <div id="menu-view">
        <div class="mode-switch-container">
            <button class="mode-switch-btn active" id="btn-practice" onclick="setMode('practice')">ğŸ› ï¸ ç»ƒä¹ æ¨¡å¼ (Practice)</button>
            <button class="mode-switch-btn exam-mode" id="btn-exam" onclick="setMode('exam')">â±ï¸ æ¨¡è€ƒæ¨¡å¼ (Exam)</button>
        </div>

        <div style="text-align:center; margin-top:10px;">
            <h2 id="mode-title">Practice Mode</h2>
            <p style="color:#666" id="mode-desc">å³æ—¶åé¦ˆä¸ AI è§£æ</p>
        </div>

        <div class="filter-section">
            <label style="font-size:14px; font-weight:bold; color:#555;">ğŸ“š é¢˜åº“ç­›é€‰:</label>
            <select id="set-select"><option value="all">All Questions</option></select>
        </div>
        
        <div class="menu-grid">
            <div class="mode-card synonym" onclick="startQuiz('synonym')">
                <span class="mode-icon">ğŸ“</span>
                <span class="mode-title">åŒä¹‰è¯</span>
                <span class="mode-desc">Synonyms</span>
            </div>
            <div class="mode-card analogy" onclick="startQuiz('analogy')">
                <span class="mode-icon">âš–ï¸</span>
                <span class="mode-title">ç±»æ¯”è¯</span>
                <span class="mode-desc">Analogies</span>
            </div>
            <div class="mode-card mistakes" onclick="startQuiz('mistakes')">
                <span class="mode-icon">ğŸ“•</span>
                <span class="mode-title">é”™é¢˜é‡ç»ƒ <span id="mistake-count" class="badge">0</span></span>
                <span class="mode-desc">Review Your Mistakes</span>
            </div>
            <div class="mode-card wordbank" onclick="showWordBankView()">
                <span class="mode-icon" style="color:var(--bank-color);">ğŸ—‚ï¸</span>
                <span class="mode-title" style="color:var(--bank-color);">è¯æ±‡åº“</span>
                <span class="mode-desc">Word Bank</span>
            </div>
        </div>
    </div>

    <div id="quiz-view" class="quiz-card practice-mode">
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
        
        <div class="question-type-tag">
            <span id="q-set" class="set-badge">Default</span>
            <span id="q-type">Type</span>
        </div>
        
        <div class="question-area">
            <div class="question-text" id="q-text">Loading...</div>
            <button class="speak-btn" onclick="speakCurrentQuestion()" title="Play Audio">ğŸ”Š</button>
        </div>
        
        <div class="options-grid" id="options-container"></div>

        <div class="feedback-area">
            <div id="result-msg" style="font-weight:bold; width: 100%; text-align:center; margin-bottom: 10px;"></div>
            <button class="action-btn ai-explain-btn" id="ai-explain-btn" onclick="explainCurrentQuestion()">âœ¨ AI è§£æ</button>
            <button class="action-btn next-btn" id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¢˜ &rarr;</button>
        </div>
    </div>

    <div id="result-view" style="display:none; text-align:center; margin-top:30px;">
        <h1 style="font-size:40px;">ğŸ‰</h1>
        <h2>ç»ƒä¹ /è€ƒè¯•å®Œæˆ!</h2>
        <p>å¾—åˆ†: <span id="final-score" style="color:var(--primary); font-weight:bold; font-size:24px;">0</span></p>
        
        <div style="text-align:left; margin-top:20px;">
            <h3 style="border-bottom: 1px solid #eee; padding-bottom:10px;">ğŸ“ ç­”é¢˜æŠ¥å‘Š (ç‚¹å‡»é¢˜ç›®æŸ¥çœ‹è§£æ)</h3>
            <div id="review-list" class="review-list"></div>
        </div>

        <button class="btn btn-primary" onclick="goHome()" style="margin-top:20px; padding: 15px 40px;">è¿”å›ä¸»é¡µ</button>
    </div>

    <div id="word-bank-view" style="display:none;">
        <h2 style="color:var(--bank-color);">ğŸ—‚ï¸ è¯æ±‡åº“ (Word Bank)</h2>
        <div class="filter-section">
            <label style="font-size:14px; font-weight:bold; color:#555;">æ‰‹åŠ¨æ·»åŠ å•è¯:</label>
            <div class="word-bank-header">
                <input type="text" id="manual-word-input" placeholder="è¾“å…¥å•è¯ (å¦‚: ABATE)" style="flex: 1; margin-bottom: 0;">
                <input type="text" id="manual-word-set" placeholder="å¥—é¢˜åç§° (å¯é€‰)" style="flex: 1; margin-bottom: 0;">
            </div>
            <button class="btn" style="background:var(--bank-color); color:white; width:100%;" onclick="addManualWord()">
                <span id="add-word-text">æ·»åŠ å¹¶è§£æ</span>
                <span id="add-word-loading" style="display:none;"><div class="loading-spinner" style="width:16px; height:16px; border-top-color: white; margin:0 auto;"></div></span>
            </button>
            <p style="font-size: 12px; color:#888; text-align:center; margin-top: 10px;">ğŸ’¡ é¦–æ¬¡è¿›å…¥æ—¶ï¼Œé¢˜åº“ä¸­çš„åŒä¹‰è¯å°†è‡ªåŠ¨å¯¼å…¥ã€‚</p>
        </div>

        <div id="word-bank-list" class="word-bank-list" style="margin-top: 20px;">
            </div>
    </div>
</div>

<div class="app-footer">
    <span id="status-msg">âœ… Ready</span>
    <span id="version-tag">v4.3 Pro+</span>
</div>

<div id="import-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>ğŸ“¥ æ‰¹é‡å¯¼å…¥</h3><button class="btn btn-close" onclick="closeModal('import-modal')">X</button></div>
        <div class="modal-body">
            <input type="text" id="import-set-name" placeholder="å¥—é¢˜åç§°...">
            <div class="file-drop-area" onclick="document.getElementById('file-input').click()">
                <span id="file-label">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ (.pdf, .docx, .txt)</span>
                <input type="file" id="file-input" multiple style="display:none;" accept=".txt,.pdf,.docx" onchange="handleFileUpload(this)">
            </div>
            <div id="file-parsing-status" style="display:none;color:#666;font-size:12px;text-align:center;margin-bottom:10px;"></div>
            <textarea id="import-text" placeholder="æˆ–ç²˜è´´æ–‡æœ¬..."></textarea>
            <div id="import-loading" style="display:none;text-align:center;"><div class="loading-spinner"></div>AI è§£æä¸­...</div>
            <button class="btn btn-ai btn-block" onclick="smartImport()">âœ¨ æ™ºèƒ½å¯¼å…¥</button>
        </div>
    </div>
</div>

<div id="gen-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>âœ¨ AI ç”Ÿæˆ</h3><button class="btn btn-close" onclick="closeModal('gen-modal')">X</button></div>
        <div class="modal-body" style="text-align:center;">
            <input type="text" id="gen-set-name" placeholder="å¥—é¢˜åç§°..." style="margin-bottom:20px;">
            <button class="btn btn-primary btn-block" onclick="generateQuestions('synonym')">ç”ŸæˆåŒä¹‰è¯</button>
            <button class="btn btn-block" style="background:var(--accent);color:white;" onclick="generateQuestions('analogy')">ç”Ÿæˆç±»æ¯”é¢˜</button>
            <div id="gen-loading" style="display:none;"><div class="loading-spinner"></div>AI å‡ºé¢˜ä¸­...</div>
        </div>
    </div>
</div>

<div id="explain-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3 style="color:var(--ai-color)">âœ¨ AI è§£æ</h3><button class="btn btn-close" onclick="closeModal('explain-modal')">å…³é—­</button></div>
        <div class="modal-body" id="explain-content"></div>
    </div>
</div>

<div id="data-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3><button class="btn btn-close" onclick="closeModal('data-modal')">X</button></div>
        <div class="modal-body">
            <div class="data-action-card">
                <div class="data-action-title">ğŸ“¥ å¯¼å‡ºå¤‡ä»½</div>
                <button class="btn btn-save btn-block" onclick="downloadBackup()">ä¸‹è½½å¤‡ä»½æ–‡ä»¶ (.json)</button>
            </div>
            <div class="data-action-card">
                <div class="data-action-title">ğŸ“¤ æ¢å¤å¤‡ä»½</div>
                <button class="btn btn-outline btn-block" onclick="document.getElementById('restore-file-input').click()">é€‰æ‹©å¤‡ä»½æ–‡ä»¶...</button>
                <input type="file" id="restore-file-input" style="display:none;" accept=".json" onchange="handleRestoreFile(this)">
            </div>
            <div class="data-action-card">
                <div class="data-action-title">âš™ï¸ é«˜çº§ç¼–è¾‘</div>
                <button class="btn btn-primary btn-block" onclick="openRawEditor()">æ‰“å¼€ JSON ç¼–è¾‘å™¨</button>
            </div>
        </div>
    </div>
</div>

<div id="raw-editor-modal" class="modal" style="z-index: 110;">
    <div class="modal-content">
        <div class="modal-header"><h3>JSON Editor</h3><div><button class="btn btn-close" onclick="closeModal('raw-editor-modal')">Cancel</button><button class="btn btn-primary" onclick="saveRawData()">Save</button></div></div>
        <div class="modal-body"><textarea id="data-input" style="height:300px;" spellcheck="false"></textarea></div>
    </div>
</div>

<script>
    // **é‡è¦æç¤º: è¿™æ˜¯ä¸€ä¸ªå ä½ç¬¦ã€‚åœ¨æ‚¨çš„æœ¬åœ°ç¯å¢ƒä¸­ï¼Œæ‚¨éœ€è¦æ›¿æ¢ä¸ºæœ‰æ•ˆçš„ Gemini API Key æ‰èƒ½å¯ç”¨ AI åŠŸèƒ½ã€‚**
    const apiKey = "AIzaSyBHYnV7uxj8ZLaNrjjDZlnN_bn1b0JSKxk"; 

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // --- æ ¸å¿ƒæ•°æ® (åˆå§‹é¢˜åº“) ---
    const defaultData = [
        // Synonyms
        { "set": "Standard List", "type": "synonym", "question": "ABATE", "options": ["Lessen", "Increase", "Anger", "Create", "Leak"], "answer": 0, "wrongCount": 0 },
        { "set": "Standard List", "type": "synonym", "question": "CANDID", "options": ["Sweet", "Hidden", "Dishonest", "Frank", "Complex"], "answer": 3, "wrongCount": 0 },
        { "set": "Standard List", "type": "synonym", "question": "OBSCURE", "options": ["Famous", "Clear", "Unclear", "Bright", "Standard"], "answer": 2, "wrongCount": 0 },
        { "set": "Standard List", "type": "synonym", "question": "PRAGMATIC", "options": ["Practical", "Dreamy", "Colorful", "Impossible", "Rigid"], "answer": 0, "wrongCount": 0 },
        { "set": "Standard List", "type": "synonym", "question": "BENEVOLENT", "options": ["Violent", "Kind", "Poor", "Rich", "Sad"], "answer": 1, "wrongCount": 0 },
        { "set": "Standard List", "type": "synonym", "question": "DILIGENT", "options": ["Lazy", "Hardworking", "Lucky", "Fast", "Slow"], "answer": 1, "wrongCount": 0 },
        { "set": "Standard List", "type": "synonym", "question": "INEVITABLE", "options": ["Uncertain", "Unavoidable", "Possible", "Unlikely", "Rare"], "answer": 1, "wrongCount": 0 },
        { "set": "Standard List", "type": "synonym", "question": "SUPERFLUOUS", "options": ["Necessary", "Unnecessary", "Superior", "Fluid", "Important"], "answer": 1, "wrongCount": 0 },
        { "set": "Standard List", "type": "synonym", "question": "VENERABLE", "options": ["Young", "Respected", "Weak", "Vulnerable", "New"], "answer": 1, "wrongCount": 0 },
        { "set": "Standard List", "type": "synonym", "question": "EPHEMERAL", "options": ["Lasting", "Short-lived", "Heavy", "Light", "Eternal"], "answer": 1, "wrongCount": 0 },
        
        // Analogies
        { "set": "Standard List", "type": "analogy", "question": "FIRE : HOT", "options": ["Ice : Cold", "Sun : Yellow", "Ground : Wet", "Sand : Dry", "Wind : Blow"], "answer": 0, "wrongCount": 0 },
        { "set": "Standard List", "type": "analogy", "question": "PEN : WRITE", "options": ["Book : Read", "Gun : Shoot", "Knife : Cut", "Chair : Sit", "Boat : Sail"], "answer": 2, "wrongCount": 0 },
        { "set": "Standard List", "type": "analogy", "question": "OPTIMIST : HOPE", "options": ["Pessimist : Doubt", "Teacher : School", "Doctor : Cure", "Artist : Paint", "Driver : Car"], "answer": 0, "wrongCount": 0 },
        { "set": "Standard List", "type": "analogy", "question": "SCALPEL : SURGEON", "options": ["Pen : Writer", "Brush : Painter", "Telescope : Astronomer", "Hammer : Carpenter", "Cleaver : Butcher"], "answer": 3, "wrongCount": 0 },
        { "set": "Standard List", "type": "analogy", "question": "CHAPTER : BOOK", "options": ["Glass : Water", "Room : House", "Tree : Forest", "Leaf : Root", "Time : Watch"], "answer": 1, "wrongCount": 0 },
        { "set": "Standard List", "type": "analogy", "question": "HUNGRY : FAMISHED", "options": ["Tired : Exhausted", "Sad : Happy", "Big : Small", "Old : New", "Hot : Cold"], "answer": 0, "wrongCount": 0 },
        { "set": "Standard List", "type": "analogy", "question": "BIRD : FLOCK", "options": ["Cow : Herd", "Fish : School", "Wolf : Pack", "Lion : Pride", "All of the above"], "answer": 1, "wrongCount": 0 },
        { "set": "Standard List", "type": "analogy", "question": "TELESCOPE : STAR", "options": ["Microscope : Cell", "Glasses : Eye", "Camera : Picture", "Mirror : Face", "Window : View"], "answer": 0, "wrongCount": 0 },
        { "set": "Standard List", "type": "analogy", "question": "PAINTER : BRUSH", "options": ["Conductor : Baton", "Writer : Pen", "Doctor : Stethoscope", "Chef : Knife", "All of the above"], "answer": 0, "wrongCount": 0 },
        { "set": "Standard List", "type": "analogy", "question": "DROUGHT : RAIN", "options": ["Famine : Food", "Silence : Noise", "Darkness : Light", "Poverty : Money", "Sickness : Medicine"], "answer": 0, "wrongCount": 0 }
    ];

    // --- çŠ¶æ€ ---
    let currentData = [];
    let wordBankData = []; // NEW: Word Bank Data
    let quizQueue = [];
    let examResults = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let isAnswered = false;
    let currentMode = 'practice';
    let autoSound = true;

    function init() {
        // å°è¯•åŠ è½½æœ¬åœ°å­˜å‚¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ defaultData
        const saved = localStorage.getItem('ssat_data_v5'); 
        if (saved) {
            try { currentData = JSON.parse(saved); } catch(e) { currentData = defaultData; }
        } else {
            currentData = defaultData;
        }
        
        // NEW: Load word bank data
        const savedBank = localStorage.getItem('ssat_word_bank_v1');
        if (savedBank) {
            try { wordBankData = JSON.parse(savedBank); } catch(e) { wordBankData = []; }
        } else {
            // Auto import initial synonym words on first load
            autoPopulateWordBank();
        }

        const savedMode = localStorage.getItem('ssat_mode');
        if(savedMode) setMode(savedMode);
        else setMode('practice');

        const savedSound = localStorage.getItem('ssat_sound');
        if(savedSound === 'false') {
            autoSound = false;
            document.getElementById('sound-toggle').classList.remove('active');
        } else {
            document.getElementById('sound-toggle').classList.add('active');
        }

        updateSetSelector();
        updateMistakeCount();
        
        if (window.speechSynthesis) { window.speechSynthesis.getVoices(); }
    }

    // NEW: Auto populate word bank from synonym questions on first run
    function autoPopulateWordBank() {
        const existingWords = new Set(wordBankData.map(item => item.word));
        currentData.filter(q => q.type === 'synonym').forEach(q => {
            const word = q.question.toUpperCase().trim();
            if (!existingWords.has(word)) {
                // Add the word with placeholder data
                wordBankData.push({
                    word: word,
                    set: q.set || 'Uncategorized',
                    chinese: 'åŠ è½½ä¸­...', 
                    english: 'Loading...', 
                    example: 'Loading...',
                    isEnriched: false
                });
                existingWords.add(word);
            }
        });
        saveToLocal();
    }
    
    function updateSetSelector() {
        const selector = document.getElementById('set-select');
        const currentVal = selector.value;
        const sets = new Set(currentData.map(i => i.set || 'Uncategorized'));
        selector.innerHTML = '<option value="all">All Questions</option>';
        sets.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.innerText = s;
            selector.appendChild(opt);
        });
        if([...selector.options].some(o=>o.value===currentVal)) selector.value = currentVal;
    }

    function updateMistakeCount() {
        document.getElementById('mistake-count').innerText = currentData.filter(i => (i.wrongCount||0)>0).length;
    }

    function setMode(mode) {
        currentMode = mode;
        localStorage.setItem('ssat_mode', mode);
        document.getElementById('btn-practice').classList.toggle('active', mode === 'practice');
        document.getElementById('btn-exam').classList.toggle('active', mode === 'exam');
        
        if(mode === 'practice') {
            document.getElementById('mode-title').innerText = "Practice Mode (ç»ƒä¹ æ¨¡å¼)";
            document.getElementById('mode-desc').innerText = "å³æ—¶åé¦ˆä¸ AI è§£æ";
        } else {
            document.getElementById('mode-title').innerText = "Exam Mode (æ¨¡è€ƒæ¨¡å¼)";
            document.getElementById('mode-desc').innerText = "æ— æç¤ºï¼Œè€ƒåç»Ÿä¸€æ‰¹æ”¹";
        }
    }

    function toggleSound() {
        autoSound = !autoSound;
        localStorage.setItem('ssat_sound', autoSound);
        document.getElementById('sound-toggle').classList.toggle('active', autoSound);
    }

    function speakCurrentQuestion() {
        const q = quizQueue[currentQuestionIndex];
        if(!q) return;
        
        let textToSpeak = q.question;
        if(q.type === 'analogy' && textToSpeak.includes(':')) {
            textToSpeak = textToSpeak.replace(':', ' is to ');
        }

        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(textToSpeak);
        u.lang = 'en-US';
        u.rate = 0.85;

        // å°è¯•ä½¿ç”¨é«˜è´¨é‡çš„è‹±æ–‡è¯­éŸ³
        const voices = window.speechSynthesis.getVoices();
        const targetVoice = voices.find(v => v.name === 'Google US English') || 
                            voices.find(v => v.name === 'Samantha') ||
                            voices.find(v => v.name.includes('US')) ||
                            voices.find(v => v.lang === 'en-US');
        if (targetVoice) u.voice = targetVoice;

        window.speechSynthesis.speak(u);
    }

    function startQuiz(type) {
        // ... (Quiz logic remains the same)
        const setFilter = document.getElementById('set-select').value;
        let filtered = [];

        if (type === 'mistakes') {
            filtered = currentData.filter(item => (item.wrongCount || 0) > 0);
            if (setFilter !== 'all') filtered = filtered.filter(item => item.set === setFilter);
            if (filtered.length === 0) return alert("æ²¡æœ‰é”™é¢˜è®°å½•ï¼");
        } else {
            filtered = currentData.filter(item => {
                const tMatch = item.type === type;
                const sMatch = setFilter === 'all' || item.set === setFilter;
                return tMatch && sMatch;
            });
            if (filtered.length === 0) return alert("é¢˜åº“ä¸ºç©ºã€‚");
        }

        quizQueue = filtered.sort(() => 0.5 - Math.random());
        currentQuestionIndex = 0;
        score = 0;
        examResults = [];

        document.getElementById('menu-view').style.display = 'none';
        document.getElementById('result-view').style.display = 'none';
        document.getElementById('word-bank-view').style.display = 'none'; // Ensure new view is hidden
        document.getElementById('quiz-view').style.display = 'block';
        document.getElementById('back-btn').style.display = 'block';

        const quizCard = document.getElementById('quiz-view');
        if(currentMode === 'exam') {
            quizCard.classList.add('exam-mode');
            quizCard.classList.remove('practice-mode');
        } else {
            quizCard.classList.remove('exam-mode');
            quizCard.classList.add('practice-mode');
        }

        loadQuestion();
    }

    function loadQuestion() {
        // ... (loadQuestion logic remains the same)
        isAnswered = false;
        const q = quizQueue[currentQuestionIndex];
        
        document.getElementById('q-set').innerText = q.set || 'Set';
        document.getElementById('q-type').innerText = q.type.toUpperCase();
        document.getElementById('q-text').innerText = q.question;
        
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('ai-explain-btn').style.display = 'none';
        document.getElementById('result-msg').innerText = '';

        const pct = ((currentQuestionIndex) / quizQueue.length) * 100;
        document.getElementById('progress').style.width = pct + '%';

        const container = document.getElementById('options-container');
        container.innerHTML = '';

        q.options.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = `${String.fromCharCode(65 + index)}. ${opt}`;
            btn.onclick = () => handleOptionClick(index, btn);
            container.appendChild(btn);
        });

        if(autoSound) setTimeout(speakCurrentQuestion, 500);
    }

    function handleOptionClick(idx, btn) {
        // ... (handleOptionClick logic remains the same)
        if(currentMode === 'practice') {
            if (isAnswered) return;
            checkAnswerPractice(idx, btn);
        } else {
            // æ¨¡è€ƒæ¨¡å¼ï¼šé€‰æ‹©ç­”æ¡ˆï¼Œç­‰å¾…ç‚¹å‡»ä¸‹ä¸€é¢˜
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            const nextBtn = document.getElementById('next-btn');
            nextBtn.style.display = 'inline-block';
            nextBtn.onclick = () => submitExamAnswer(idx);
        }
    }

    function checkAnswerPractice(idx, btn) {
        // ... (checkAnswerPractice logic remains the same)
        isAnswered = true;
        const q = quizQueue[currentQuestionIndex];
        const buttons = document.querySelectorAll('.option-btn');
        const isCorrect = (idx === q.answer);
        
        examResults.push({ question: q, userAnswer: idx, isCorrect: isCorrect });

        if (isCorrect) {
            btn.classList.add('correct');
            score++;
            document.getElementById('result-msg').innerHTML = "<span style='color:var(--correct)'>Correct! âœ…</span>";
        } else {
            btn.classList.add('wrong');
            buttons[q.answer].classList.add('correct');
            document.getElementById('result-msg').innerHTML = "<span style='color:var(--wrong)'>Incorrect âŒ</span>";
            // è®°å½•é”™é¢˜
            q.wrongCount = (q.wrongCount || 0) + 1;
            saveToLocal();
        }
        document.getElementById('next-btn').style.display = 'inline-flex';
        document.getElementById('next-btn').onclick = nextQuestion;
        document.getElementById('ai-explain-btn').style.display = 'inline-flex';
    }

    function submitExamAnswer(idx) {
        // ... (submitExamAnswer logic remains the same)
        // æ¨¡è€ƒæ¨¡å¼çš„ç­”æ¡ˆæäº¤
        const q = quizQueue[currentQuestionIndex];
        const isCorrect = (idx === q.answer);
        examResults.push({ question: q, userAnswer: idx, isCorrect: isCorrect });
        if(isCorrect) { score++; } 
        else { 
            // æ¨¡è€ƒæ¨¡å¼ä¹Ÿè®°å½•é”™é¢˜
            q.wrongCount = (q.wrongCount || 0) + 1; 
            saveToLocal(); 
        }
        nextQuestion();
    }

    function nextQuestion() {
        // ... (nextQuestion logic remains the same)
        currentQuestionIndex++;
        if (currentQuestionIndex < quizQueue.length) loadQuestion();
        else showResults();
    }

    function showResults() {
        // ... (showResults logic remains the same)
        document.getElementById('quiz-view').style.display = 'none';
        document.getElementById('result-view').style.display = 'block';
        document.getElementById('back-btn').style.display = 'none';
        
        document.getElementById('final-score').innerText = `${score} / ${quizQueue.length}`;

        const listContainer = document.getElementById('review-list');
        listContainer.innerHTML = '';

        examResults.forEach((res, index) => {
            const item = document.createElement('div');
            item.className = `review-item ${res.isCorrect ? 'correct' : 'wrong'}`;
            const userAnsText = res.question.options[res.userAnswer] || "Skipped";
            const correctAnsText = res.question.options[res.question.answer];

            item.innerHTML = `
                <div class="review-q">
                    <span>${index+1}. ${res.question.question}</span>
                    <span>${res.isCorrect ? 'âœ…' : 'âŒ'} <span class="ai-tag">ç‚¹å‡»çœ‹è§£æ</span></span>
                </div>
                <div class="review-meta">
                    æ‚¨çš„ç­”æ¡ˆ: ${userAnsText} <br>
                    ${!res.isCorrect ? `<strong>æ­£ç¡®ç­”æ¡ˆ: ${correctAnsText}</strong>` : ''}
                </div>
            `;
            item.onclick = () => explainSpecificQuestion(res.question);
            listContainer.appendChild(item);
        });
    }

    function goHome() {
        document.getElementById('menu-view').style.display = 'block';
        document.getElementById('quiz-view').style.display = 'none';
        document.getElementById('result-view').style.display = 'none';
        document.getElementById('word-bank-view').style.display = 'none'; // Ensure new view is hidden
        document.getElementById('back-btn').style.display = 'none';
        updateSetSelector();
        updateMistakeCount(); 
    }

    async function explainCurrentQuestion() {
        const q = quizQueue[currentQuestionIndex];
        explainSpecificQuestion(q);
    }

    // AI è§£æåŠŸèƒ½çš„å ä½é€»è¾‘
    async function explainSpecificQuestion(q) {
        document.getElementById('explain-modal').style.display = 'flex';
        document.getElementById('explain-content').innerHTML = '<div class="loading-spinner"></div>';
        
        const prompt = `Explain SSAT question concisely in markdown. Question: "${q.question}", Options: ${JSON.stringify(q.options)}, Answer: ${q.options[q.answer]}.`;
        
        const text = await callGemini(prompt, "Tutor"); // å°è¯•è°ƒç”¨ Gemini API
        if (text) {
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            document.getElementById('explain-content').innerHTML = `<div class="markdown-content">${html}</div>`;
        } else {
            // å¦‚æœ AI è°ƒç”¨å¤±è´¥ï¼Œæä¾›é»˜è®¤æç¤º
            document.getElementById('explain-content').innerHTML = `
                <h3>âœ¨ ç¦»çº¿è§£æ</h3>
                <p><strong>é¢˜ç›®:</strong> ${q.question}</p>
                <p><strong>æ­£ç¡®ç­”æ¡ˆ:</strong> ${String.fromCharCode(65 + q.answer)}. ${q.options[q.answer]}</p>
                <p style="color:red;"><strong>AI åŠŸèƒ½æœªå¯ç”¨:</strong> è¯·åœ¨æºä»£ç ä¸­é…ç½®æœ‰æ•ˆçš„ Gemini API Key (apiKey å˜é‡)ï¼Œä»¥ä¾¿è·å–å®æ—¶è§£æã€‚</p>
            `;
        }
    }

    // --- NEW: Word Bank Functions ---
    
    function showWordBankView() {
        document.getElementById('menu-view').style.display = 'none';
        document.getElementById('quiz-view').style.display = 'none';
        document.getElementById('result-view').style.display = 'none';
        document.getElementById('word-bank-view').style.display = 'block';
        document.getElementById('back-btn').style.display = 'block';
        
        renderWordBank();
        // Trigger enrichment for any non-enriched words if API key exists
        if (apiKey) {
             wordBankData.filter(w => !w.isEnriched).forEach(w => enrichAndAddWord(w.word, w.set, true));
        }
    }

    function renderWordBank() {
        const container = document.getElementById('word-bank-list');
        container.innerHTML = '';
        
        // 1. æŒ‰å•è¯å­—æ¯æ’åº
        const sortedWords = [...wordBankData].sort((a, b) => a.word.localeCompare(b.word));
        
        // 2. æŒ‰ Set åˆ†ç»„
        const wordsBySet = sortedWords.reduce((acc, item) => {
            const set = item.set || 'Uncategorized';
            if (!acc[set]) acc[set] = [];
            acc[set].push(item);
            return acc;
        }, {});
        
        // 3. æ¸²æŸ“
        Object.keys(wordsBySet).sort().forEach(set => {
            const setHeader = document.createElement('div');
            setHeader.className = 'word-set-header';
            setHeader.innerText = `ğŸ“š ${set} (${wordsBySet[set].length} è¯)`;
            container.appendChild(setHeader);

            wordsBySet[set].forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'word-item';
                itemDiv.innerHTML = `
                    <div class="word-title">${index + 1}. ${item.word}</div>
                    <div class="word-detail">
                        <strong>ğŸ‡¨ğŸ‡³ æ±‰è¯‘:</strong> ${item.chinese} <br>
                        <strong>ğŸ‡¬ğŸ‡§ è‹±è§£:</strong> ${item.english} <br>
                        <strong>ğŸ“ ä¾‹å¥:</strong> ${item.example}
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        });

        if (wordBankData.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#888;">è¯æ±‡åº“ä¸ºç©ºã€‚è¯·ä»é¢˜åº“å¯¼å…¥æˆ–æ‰‹åŠ¨æ·»åŠ ã€‚</p>';
        }
    }

    function addManualWord() {
        const input = document.getElementById('manual-word-input');
        const setInput = document.getElementById('manual-word-set');
        const word = input.value.trim().toUpperCase();
        const set = setInput.value.trim() || 'Manual Input';

        if (!word) {
            alert('è¯·è¾“å…¥ä¸€ä¸ªå•è¯ï¼');
            return;
        }

        enrichAndAddWord(word, set, false);

        input.value = '';
        setInput.value = '';
    }

    // New: Function to enrich word using AI or provide placeholder
    async function enrichAndAddWord(word, set, isAutoImport) {
        const existingIndex = wordBankData.findIndex(item => item.word === word && item.set === set);

        // If it's a non-enriched word from auto-import, we update the existing one
        // If it's a manual input and already exists, alert and return
        if (existingIndex !== -1 && !isAutoImport) {
            alert(`å•è¯ "${word}" å·²ç»åœ¨å¥—é¢˜ "${set}" ä¸­äº†ã€‚`);
            return;
        }

        const isNewWord = existingIndex === -1;
        
        let newItem = {
            word: word,
            set: set,
            chinese: isAutoImport ? 'åŠ è½½ä¸­...' : 'è§£æä¸­...',
            english: isAutoImport ? 'Loading...' : 'Parsing...',
            example: isAutoImport ? 'Loading...' : 'Parsing...',
            isEnriched: false
        };

        if (isNewWord) {
            wordBankData.push(newItem);
        } else {
            newItem = wordBankData[existingIndex];
        }

        renderWordBank();
        
        const loadingSpan = document.getElementById('add-word-loading');
        const textSpan = document.getElementById('add-word-text');
        
        if (!isAutoImport) {
            loadingSpan.style.display = 'inline-block';
            textSpan.style.display = 'none';
        }


        if (apiKey) {
            try {
                const prompt = `Provide the following information for the word "${word}" (an SSAT-level vocabulary word) in a single JSON object. The Chinese translation must be concise. The English definition should be short and suitable for a middle school student. The example sentence should be relevant to the word's meaning. Return ONLY a JSON object: {"chinese": "...", "english": "...", "example": "..."}.`;
                
                const result = await callGemini(prompt, "Vocabulary Assistant");
                
                if (result) {
                    const jsonStr = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const enrichment = JSON.parse(jsonStr);
                    
                    if (enrichment.chinese && enrichment.english && enrichment.example) {
                        newItem.chinese = enrichment.chinese;
                        newItem.english = enrichment.english;
                        newItem.example = enrichment.example;
                        newItem.isEnriched = true;
                    }
                }
            } catch (e) {
                newItem.chinese = 'AI è§£æå¤±è´¥: æ ¼å¼é”™è¯¯æˆ–ç½‘ç»œé—®é¢˜';
                newItem.english = 'AI Parsing Failed';
                newItem.example = 'Please check console for error details.';
                console.error("AI Enrichment Error:", e);
            }
        } else {
            // Placeholder if no API Key
            newItem.chinese = 'æœªé…ç½® API Keyï¼ŒAI åŠŸèƒ½ç¦ç”¨';
            newItem.english = 'No API Key configured. AI is disabled.';
            newItem.example = 'Please configure key to auto-enrich.';
            newItem.isEnriched = true; // Mark as done to prevent re-try if no key
        }

        if (isNewWord) {
             wordBankData[wordBankData.length - 1] = newItem; // Update the newly pushed item
        } else if(existingIndex !== -1) {
             wordBankData[existingIndex] = newItem; // Update the existing item
        }

        saveToLocal();
        renderWordBank();
        
        if (!isAutoImport) {
            loadingSpan.style.display = 'none';
            textSpan.style.display = 'inline-block';
        }
    }
    
    // --- End of NEW: Word Bank Functions ---
    
    // --- Modal & Utils (mostly unchanged, only slight refactor to saveToLocal) ---
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showImportModal() { document.getElementById('import-modal').style.display = 'flex'; }
    function showGenModal() { document.getElementById('gen-modal').style.display = 'flex'; }
    function showDataModal() { document.getElementById('data-modal').style.display = 'flex'; }

    function downloadBackup() {
        // Save both data and word bank
        const backupData = {
            quizData: currentData,
            wordBank: wordBankData
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
        const anchor = document.createElement('a');
        anchor.setAttribute("href", dataStr);
        anchor.setAttribute("download", "ssat_backup.json");
        document.body.appendChild(anchor);
        anchor.click();
        anchor.remove();
        alert("å¤‡ä»½å·²ä¸‹è½½ï¼");
    }

    async function handleRestoreFile(input) {
        const file = input.files[0];
        if (!file) return;
        try {
            const text = await file.text();
            const parsed = JSON.parse(text);
            
            let newQuizData, newWordBank;

            if (Array.isArray(parsed)) {
                // Old format support
                newQuizData = parsed;
                newWordBank = [];
            } else if (parsed.quizData) {
                // New format with both
                newQuizData = parsed.quizData;
                newWordBank = parsed.wordBank || [];
            } else {
                throw new Error("æ ¼å¼é”™è¯¯");
            }

            if(confirm(`æ¢å¤å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ`)) {
                currentData = newQuizData;
                wordBankData = newWordBank; // Restore word bank data
                saveToLocal();
                updateSetSelector();
                updateMistakeCount();
                alert("æ¢å¤æˆåŠŸï¼");
                closeModal('data-modal');
            }
        } catch(e) { alert("é”™è¯¯: " + e.message); }
        input.value = '';
    }

    function openRawEditor() {
        document.getElementById('raw-editor-modal').style.display = 'flex';
        // Show both data structures in raw editor for completeness
        const rawObj = {
            quizData: currentData,
            wordBank: wordBankData
        };
        document.getElementById('data-input').value = JSON.stringify(rawObj, null, 4);
    }

    function saveRawData() {
        try {
            const raw = document.getElementById('data-input').value;
            const parsed = JSON.parse(raw);
            
            if (parsed.quizData) {
                currentData = parsed.quizData;
                wordBankData = parsed.wordBank || [];
            } else if (Array.isArray(parsed)) {
                // Assume old format for backward compatibility
                currentData = parsed;
                wordBankData = [];
            } else {
                throw new Error("JSON structure invalid. Should contain 'quizData'.");
            }
            
            saveToLocal();
            updateSetSelector();
            updateMistakeCount();
            closeModal('raw-editor-modal');
            closeModal('data-modal');
            alert("ä¿å­˜æˆåŠŸ");
        } catch(e) { alert("JSON é”™è¯¯: " + e.message); }
    }

    // æ–‡ä»¶ä¸Šä¼ è§£æé€»è¾‘ (TXT, DOCX, PDF)
    async function handleFileUpload(input) {
        const files = input.files;
        if (!files.length) return;
        const status = document.getElementById('file-parsing-status');
        const textarea = document.getElementById('import-text');
        status.style.display = 'block';
        status.innerText = `æ­£åœ¨è§£æ ${files.length} ä¸ªæ–‡æ¡£...`;
        let combinedText = "";
        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                let fileText = "";
                if (file.name.endsWith('.txt')) fileText = await file.text();
                else if (file.name.endsWith('.docx')) {
                    const ab = await file.arrayBuffer();
                    const res = await mammoth.extractRawText({ arrayBuffer: ab });
                    fileText = res.value;
                } else if (file.name.endsWith('.pdf')) {
                    const ab = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
                    for (let p = 1; p <= pdf.numPages; p++) {
                        const page = await pdf.getPage(p);
                        const content = await page.getTextContent();
                        fileText += content.items.map(i=>i.str).join(' ') + "\n";
                    }
                }
                if(fileText) combinedText += `\n--- ${file.name} ---\n` + fileText + "\n";
            }
            textarea.value = (textarea.value ? textarea.value + "\n\n" : "") + combinedText;
            status.innerText = "è§£ææˆåŠŸï¼è¯·ç‚¹å‡»'æ™ºèƒ½å¯¼å…¥'å°†æ–‡æœ¬è½¬æ¢ä¸ºé¢˜ç›®ã€‚";
        } catch (err) { status.innerText = "è§£æå¤±è´¥: " + err.message; }
    }

    // é€šç”¨ Gemini API è°ƒç”¨ (éœ€è¦æœ‰æ•ˆçš„ apiKey)
    async function callGemini(prompt, systemPrompt = "") {
        if (!apiKey) {
            // Fallback for AI functions if key is missing
            if (systemPrompt === "Data Assistant") alert("è¯·é…ç½®æœ‰æ•ˆçš„ API Key æ‰èƒ½ä½¿ç”¨ AI æ™ºèƒ½å¯¼å…¥åŠŸèƒ½ã€‚");
            if (systemPrompt === "Content Creator") alert("è¯·é…ç½®æœ‰æ•ˆçš„ API Key æ‰èƒ½ä½¿ç”¨ AI ç”ŸæˆåŠŸèƒ½ã€‚");
            console.error("API Key is missing. AI features are disabled.");
            return null;
        }
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        if (systemPrompt) payload.systemInstruction = { parts: [{ text: systemPrompt }] };
        const delays = [1000, 2000, 4000];
        for (let i = 0; i <= delays.length; i++) {
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) {
                if (i === delays.length) { alert("AI ç¹å¿™æˆ–é…ç½®é”™è¯¯: " + error.message); return null; }
                await new Promise(r => setTimeout(r, delays[i]));
            }
        }
        return null;
    }

    // æ™ºèƒ½å¯¼å…¥åŠŸèƒ½ (éœ€è¦ AI)
    async function smartImport() {
        const text = document.getElementById('import-text').value;
        const setName = document.getElementById('import-set-name').value || "Imported";
        if (!text.trim()) return alert("å†…å®¹ä¸ºç©º");
        
        document.getElementById('import-loading').style.display = 'block';
        const prompt = `User input: """${text.substring(0, 25000)}""" Task: Convert the content into an array of SSAT vocabulary questions. Each question must have a 'set', 'type' (synonym or analogy), 'question', an array of 5 'options', and the 'answer' index (0-4). Return ONLY a JSON array. Set name: "${setName}".`;
        const result = await callGemini(prompt, "Data Assistant");
        document.getElementById('import-loading').style.display = 'none';
        if (result) {
            try {
                const jsonStr = result.replace(/```json/g, '').replace(/```/g, '').trim();
                const newItems = JSON.parse(jsonStr);
                if (Array.isArray(newItems)) {
                    const processed = newItems.map(i => ({...i, wrongCount: 0}));
                    currentData = [...currentData, ...processed];
                    
                    // Add new synonym words to the word bank
                    processed.filter(q => q.type === 'synonym').forEach(q => {
                        enrichAndAddWord(q.question.toUpperCase().trim(), q.set || 'Uncategorized', true);
                    });
                    
                    saveToLocal();
                    updateSetSelector();
                    alert(`å¯¼å…¥ ${newItems.length} é¢˜æˆåŠŸï¼`);
                    closeModal('import-modal');
                    document.getElementById('import-text').value = '';
                }
            } catch (e) { alert("AI è¿”å›æ ¼å¼é”™è¯¯: " + e.message + "\n\nåŸå§‹å†…å®¹:\n" + result); }
        }
    }

    // AI ç”ŸæˆåŠŸèƒ½ (éœ€è¦ AI)
    async function generateQuestions(type) {
        const setName = document.getElementById('gen-set-name').value || "AI Generated";
        
        document.getElementById('gen-loading').style.display = 'block';
        const typeStr = type === 'synonym' ? "SSAT Synonym" : "SSAT Analogy";
        const prompt = `Generate 5 difficult ${typeStr} questions. Each question must have a 'set', 'type' (${type}), 'question', an array of 5 'options', and the 'answer' index (0-4). JSON Array format only. Set name: "${setName}".`;
        const result = await callGemini(prompt, "Content Creator");
        document.getElementById('gen-loading').style.display = 'none';
        if (result) {
            try {
                const jsonStr = result.replace(/```json/g, '').replace(/```/g, '').trim();
                const items = JSON.parse(jsonStr).map(i => ({...i, wrongCount: 0}));
                currentData = [...currentData, ...items];
                
                // Add new synonym words to the word bank
                items.filter(q => q.type === 'synonym').forEach(q => {
                    enrichAndAddWord(q.question.toUpperCase().trim(), q.set || 'Uncategorized', true);
                });

                saveToLocal();
                updateSetSelector();
                alert(`æˆåŠŸç”Ÿæˆ ${items.length} é¢˜ï¼`);
                closeModal('gen-modal');
            } catch (e) { alert("AI è¿”å›æ ¼å¼é”™è¯¯ã€‚"); console.error(e); }
        }
    }

    function saveToLocal() {
        localStorage.setItem('ssat_data_v5', JSON.stringify(currentData));
        localStorage.setItem('ssat_word_bank_v1', JSON.stringify(wordBankData)); // NEW: Save word bank
        document.getElementById('status-msg').innerText = `âœ… æ•°æ®å·²æ›´æ–° (å…± ${currentData.length} é¢˜, ${wordBankData.length} è¯)`;
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    init();
</script>
</body>
</html>